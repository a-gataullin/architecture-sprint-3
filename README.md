# Домашняя работа №3

## Задание 1: Анализ и проектирование

### Подзадание 1.1: Анализ и планирование
Создана C4 диаграмма (System Context diagram), визуализирующая взаимодействие монолитного приложения с внешним миром: [c1.puml](c1.puml).

### Подзадание 1.2: Архитектура микросервисов
Составлены C4 диаграммы уровней контейнеров, компонентов, кода.

#### Диаграмма контейнеров ([с2.puml](c2.puml))
Сценарий получения телеметрии от датчика до пользователя в системе, описанной в диаграмме, включает несколько ключевых этапов, взаимодействующих между различными компонентами. Давайте рассмотрим этот процесс с самого начала.

1. **Запрос пользователя на показания**:
   - Пользователь использует веб-клиент (Web Client), чтобы отправить запрос на получение телеметрии. Запрос передается через `Clients API Gateway`.

2. **Аутентификация и получение данных о пользователе**:
   - `Clients API Gateway` авторизует пользователя, обращаясь к системе управления пользователями (`Users-Houses`), которая валидирует информацию и получает детали о зарегистрированных пользователях, их домах и устройствах из базы данных (`UsersHousesDB`).

3. **Получение текущих показаний**:
   - После успешной авторизации `Clients API Gateway` запрашивает текущие показания модулей (датчиков) у микросервиса `DevicesRecentMeasures`. Этот сервис обращается к базе данных (`DevicesRecentMeasuresDB`), чтобы получить актуальные данные.
   - Постоянное обновление базы данных происходит путем получения свежих показателей с очереди `MeasuresQueue`.
   - В базе данных (`DevicesRecentMeasuresDB`) хранятся только текущие показатели девайсов (не исторические данные).
   Имеем профиль большой читающей (клиенты могут poll'ить) и пишущей нагрузки (постоянного обновления данных). Поэтому предлагается использовать in-memory базы данных в пользу высокой доступности и производительности перед малой надежностью (не страшно потерять текущие данные, они обновятся). Примером может служить шардированный персистентный редис. Также, он предоставит возможность lru политики для хранения (для polling клиентов, например если пользователь настроил себе активный dashboard)

4. **Обработка и сохранение показателей**:
   - Микросервис `DevicesMeasuresCollector` собирает текущие значения с устройств, взаимодействуя с `Devices API Gateway`. Этот шлюз отправляет запросы к внешним устройствам (Sensors and Control Modules), которые возвращают актуальные данные о климате, освещении и пр.
   - Полученные данные передаются в шину `RecentMeasuresQueue`

5. **Сохранение данных телеметрии**:
   - Еще одним клиентом событий текущих показателей (кроме `DevicesRecentMeasures`) является `TelemetryService`. Сервис сохраняет их в базе данных телеметрии (`TelemetryDB`), использующей InfluxDB. Это позволяет системе хранить и обрабатывать исторические данные показателей.

6. **Запрос истории показателей**:
   - Если пользователь запрашивает историю показателей за определенный период, `Clients API Gateway` передает этот запрос в `TelemetryService`, который обращается к базе данных `TelemetryDB` для получения нужной информации и возврата её пользователю.

7. **Установка значений показателей для девайсов**:
   - Настройка показателей лежит в области ответственности сервиса `DevicesSettings`
   - Используется реляционная модель базы данных `PostgreSQL` в пользу высокой надежности и реляционности моделей перед доступностью и производительностью (нагрузка на установку настройки не такая большая)
   - Команды на дейвайсы отправляются через шину данных `SettingsQueue` и сервис `DevicesMeasuresSetter`
   - Для поддержания настройки (температуры, уровня освещения) берутся текущие показатели с шины `RecentMeasuresQueue`.

В итоге, пользователь получает актуальные или исторические данные о показаниях с датчиков через интерфейс веб-клиента. Такой сценарий обеспечивает надежное и быстрое получение телеметрии, используя модульный подход и распределенные очереди сообщений для повышения производительности и устойчивости системы.

#### Диаграмма компонентов
Составлены диаграммы для сервиса настроек показателей и сервиса телеметрии.
Файлы: [c3-devices-settings.puml](c3-devices-settings.puml), [c3-telemetry-service.puml](c3-telemetry-service.puml).

#### Диаграмма кода
Составлены диаграммы для сервиса настроек показателей и сервиса телеметрии.
Файлы: [c4-devices-settings.puml](c4-devices-settings.puml), [c4-telemetry-service.puml](c4-telemetry-service.puml).

### Подзадание 1.3: ER-диаграмма
Составлены диаграммы для сервиса настроек показателей и системы управления пользователями, домами.
Файлы: [er-devices-settings.puml](c4-devices-settings.puml), [er-users-houses.puml](c4-telemetry-service.puml).

### Подзадание 1.4: Создание и документирование API
Составлено API для основного взаймодествия с сервисом настроек показателей:     
  - REST: [swagger-api-devices-settings.yml](swagger-api-devices-settings.yml)    
  - AsyncAPI: [async-api-devices-settings.yml](async-api-devices-settings.yml)

## Задание 2: Разработка MVP
### Подзадание 2.1: Новые микросервисы и интеграция с монолитом
Реализованы два микросервиса «Управление устройствами» и «Управление телеметрией».
Здесь модели и ручки не совпадают с тем, что в диаграммах, потому что в задании больше ориентировался на тз и чаты.